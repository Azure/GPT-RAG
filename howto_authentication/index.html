
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Official project documentation">
      
      
        <meta name="author" content="Paulo Lacerda">
      
      
      
        <link rel="prev" href="../howto_azure_direct/">
      
      
        <link rel="next" href="../howto_userfeedback/">
      
      
      <link rel="icon" href="../favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.34">
    
    
      
        <title>Auth & Doc Security - GPT-RAG</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.35f28582.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../styles.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#authentication-and-document-level-security" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="GPT-RAG" class="md-header__button md-logo" aria-label="GPT-RAG" data-md-component="logo">
      
  <img src="../media/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GPT-RAG
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Auth & Doc Security
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/azure/gpt-rag" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="GPT-RAG" class="md-nav__button md-logo" aria-label="GPT-RAG" data-md-component="logo">
      
  <img src="../media/logo.png" alt="logo">

    </a>
    GPT-RAG
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/azure/gpt-rag" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../whatisnew/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    What's New
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../deploy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deployment Guide
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Quick Start Guides
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Quick Start Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart_simple_rag/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simple RAG
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart_nl2sql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NL2SQL
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Services
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Services
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_orchestrator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Orchestrator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Ingestion
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            Ingestion
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_ingestion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ingestion_blob_data_source/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blob
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ingestion_sharepoint_source/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sharepoint
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ingestion_nl2sql_data_source/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NL2SQL
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    How-to Guides
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            How-to Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../howto_azure_direct/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Direct Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Auth & Doc Security
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Auth & Doc Security
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Concepts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      Setup
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../howto_userfeedback/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    User Feedback
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../howto_sharepoint_connector/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sharepoint Connector
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../team/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meet the Team
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="authentication-and-document-level-security">Authentication and Document-Level Security</h1>
<p>This page explains how authentication works in GPT-RAG, from the GPT-RAG UI sign-in to querying Azure AI Search with document-level access control enabled (POSIX-like ACL / RBAC scopes). The key idea is intentionally simple: when authentication is configured, the UI forwards a single user token to the orchestrator, and the orchestrator takes responsibility for producing the correct “user context” token required by Azure AI Search.</p>
<blockquote>
<p>In OAuth mode, the orchestrator receives a user access token (for the orchestrator API) and then performs an On-Behalf-Of (OBO) exchange to obtain a separate token for Azure AI Search. The two tokens have different audiences and are not interchangeable.</p>
</blockquote>
<h2 id="concepts">Concepts</h2>
<p>GPT-RAG uses Microsoft Entra ID authentication end-to-end, and Azure <a href="https://learn.microsoft.com/en-us/azure/search/search-document-level-access-overview">AI Search document-level access control (POSIX-like ACL / RBAC scopes)</a> relies on three related steps:</p>
<p>1) The UI signs the user in and sends an access token to the orchestrator. This token is meant for the orchestrator API.</p>
<p>2) The orchestrator validates the incoming token (signature, issuer, and audience) and extracts the user identity (for example, user object ID). This is how the orchestrator knows which user is calling.</p>
<p>3) When the orchestrator queries Azure AI Search with document-level security enabled, it must send a different delegated token whose audience is Azure AI Search. The orchestrator obtains that token by performing an On-Behalf-Of exchange with Entra ID.</p>
<p>The diagram below shows where each token is used. Azure AI Search receives the orchestrator credential (to authorize the call) and a separate “query source authorization” token (to enforce document-level access control).</p>
<div class="no-wrap">
<div class="highlight"><pre><span></span><code>    +---------------------------+                 +----------------------------------+
    |  Microsoft Entra ID       |                 |  Azure AI Search                 |
    |  Tenant                   |                 |  Index with ACL/RBAC enforcement |
    |                           |                 |  permissionFilterOption=enabled  |
    +---------------------------+                 +----------------------------------+
            ^                                                      ^
            |                                                      |
            | (4) user access                                      | (6) Search query
            |  aud: https://search.azure.com                       |   Authorization: (orchestrator identity)
            |  scope: https://search.azure.com/user_impersonation  |   x-ms-query-source-authorization: (user access token)
            |                                                      |
            |                                                      |
            |                                                      |
    +---------------------------+         (3) OBO exchange         |
    |  Orchestrator             |----------------------------------+
    |  Container App            |   to Entra ID token endpoint
    |                           |
    |  Validates API token      |   Inputs
    |  Uses client secret       |   - incoming user access token
    |  Uses MI or admin key     |   - client id and client secret
    +---------------------------+   - requested scope for Search
                        ^
                        |
                        | (2) API token
                        |     aud: api://&lt;CLIENT_ID&gt;
                        |     scope: api://&lt;CLIENT_ID&gt;/user_impersonation
                        |
    +---------------------------+
    |  Frontend                 |
    |  Container App            |
    |  Chainlit OAuth           |
    +---------------------------+
                        ^
                        |
                        | (1) User sign-in
                        |     Entra issues API token
                        |
    +---------------------------+
    |  App Registration         |
    |  Single registration for  |
    |  UI and orchestrator      |
    +---------------------------+
</code></pre></div>
</div>

<p>When authentication is configured (OAuth enabled), the UI includes the user access token for the orchestrator API on calls to the orchestrator. This is the token shown as (2) in the diagram. If OAuth is not configured and the UI is running in anonymous mode, the UI calls the orchestrator without an <code>Authorization</code> header. In OAuth mode, the UI sends the token like this:</p>
<div class="highlight"><pre><span></span><code>Authorization: Bearer &lt;orchestrator_api_user_access_token&gt;
</code></pre></div>
<p>On the orchestrator side, this user access token is validated before any downstream call is made. The orchestrator verifies the token signature and issuer using the tenant signing keys (JWKS), checks the expected audience for the orchestrator API, and extracts the user identity (for example, user object ID). That identity can be used to enforce access to the orchestrator itself.</p>
<p>To query Azure AI Search with document-level access control enabled, the orchestrator performs an On-Behalf-Of (OBO) exchange using the incoming user access token as the user assertion. This returns a delegated user token whose audience is Azure AI Search. The orchestrator includes that token in the header below when running queries.</p>
<div class="highlight"><pre><span></span><code>x-ms-query-source-authorization: Bearer &lt;search_user_access_token&gt;
</code></pre></div>
<p>Document-level access control is enforced by Azure AI Search when the index is configured for document permissions (see <code>permissionFilterOption</code> in the index definition) and documents include permission metadata. </p>
<p>GPT-RAG uses these field names consistently across ingestion paths:</p>
<div class="highlight"><pre><span></span><code>metadata_security_user_ids
metadata_security_group_ids
metadata_security_rbac_scope
</code></pre></div>
<p>For GPT-RAG, the document-level access control model is POSIX-style ACL plus RBAC scopes. Each document can carry ACL metadata such as user and group object IDs. When applicable, a document can also carry an RBAC scope such as a storage container resource ID.</p>
<p>GPT-RAG ingestion is responsible for collecting and attaching the permission metadata for each document automatically. This repo does not rely on the built-in Azure AI Search indexers for permission extraction. Permissions are handled by the pipeline implemented in <code>gpt-rag-ingestion</code>.</p>
<p>When ACL and RBAC scope metadata are present, Azure AI Search evaluates them as alternatives. Access is granted when any one permission type matches: userIds, groupIds, or rbacScope.</p>
<p>In normal usage, userIds and groupIds contain Microsoft Entra ID object IDs as strings. They also support special values.</p>
<pre><code>- `["all"]` makes every caller match this ACL type.

- `["none"]` and `[]` mean no caller matches this ACL type.
</code></pre>
<p>These values only apply to that ACL type. For example, userIds set to <code>["none"]</code> does not block access through groupIds or RBAC scope.</p>
<p>RBAC scopes are applied at the storage container level. When RBAC is used for a document, users must have the appropriate Azure role assignment on the container scope, typically Storage Blob Data Reader.</p>
<p>In test environments, if you do not want Azure AI Search to enforce document permissions, set <code>permissionFilterOption</code> to <code>disabled</code> in the index definition. This is the default.</p>
<p>Azure AI Search enforces limits for document permission fields. The <code>userIds</code> and <code>groupIds</code> fields accept up to 32 values each. The <code>rbacScope</code> field is limited to five distinct values across the entire index.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p><strong>For user authentication</strong>
- A Microsoft Entra ID App Registration used by both the UI and the orchestrator. The UI uses it to sign users in and request an access token for the orchestrator API. The orchestrator then validates that token and uses the app's client secret to perform the On-Behalf-Of (OBO) token exchange when the Azure AI Search index is configured for document-level access control.
- You have permissions in the tenant to create or update the App Registration, add API permissions.</p>
<p><strong>For document-level security</strong>
- User authentication is configured.
- Your Azure AI Search index is configured for document-level access control and includes the required document permission fields. *
- Your documents are indexed with the correct security metadata for each document (user object IDs, group object IDs, and RBAC scope). **
- Tenant admin consent is granted for the Azure AI Search delegated permission <code>user_impersonation</code> in the App Registration.</p>
<p>* If you use the GPT-RAG provisioning workflow, it already creates the index with this configuration.</p>
<p>** If you use gpt-rag data ingetion pipeline documents are automatically indexed with ACL when they're set in the blobs metadata fields</p>
<h2 id="setup">Setup</h2>
<p><strong>1) Create one App Registration in Microsoft Entra ID.</strong></p>
<p>After creating it, go to the <strong>App Registration Overview</strong> page and copy the Application (client) ID and the Directory (tenant) ID. You will use them later as <code>OAUTH_AZURE_AD_CLIENT_ID</code> and <code>OAUTH_AZURE_AD_TENANT_ID</code>.</p>
<p>If you plan to use group-based access control, in the <strong>App Registration</strong> go to <strong>Manage &gt; Token configuration</strong> and add a <code>groups</code> claim. </p>
<p>If users belong to many groups, Entra may emit an overage indicator instead of the full group list, which typically requires resolving membership via Microsoft Graph.</p>
<p><strong>2) In the App Registration, go to Manage &gt; Authentication.</strong></p>
<p><strong>Under Platform configurations &gt; Web, add the frontend redirect URI.</strong></p>
<div class="highlight"><pre><span></span><code>https://&lt;YOUR-APP-URL&gt;/auth/oauth/azure-ad/callback
</code></pre></div>
<p><strong>3) In the App Registration, go to Manage &gt; Expose an API.</strong> </p>
<p>Set the Application ID URI to <code>api://&lt;OAUTH_AZURE_AD_CLIENT_ID&gt;</code>.</p>
<p>Then create a delegated scope named <code>user_impersonation</code> and add this scope to the app.</p>
<div class="highlight"><pre><span></span><code>api://&lt;OAUTH_AZURE_AD_CLIENT_ID&gt;/user_impersonation
</code></pre></div>
<p><strong>4) In the App Registration, go to Manage &gt; Certificates &amp; secrets.</strong></p>
<p><strong>Create a new client secret and copy the secret value.</strong></p>
<p>You can only copy the secret value once. Store it securely (for example, in Key Vault) and use it later for the orchestrator configuration.</p>
<p><strong>5) Add the Azure AI Search delegated permission <code>user_impersonation</code> and grant tenant consent.</strong></p>
<p>In the App Registration, go to <strong>Manage &gt; API permissions</strong>.</p>
<div class="highlight"><pre><span></span><code>Add a permission
    APIs my organization uses
        Azure Cognitive Search
            Delegated permissions
                user_impersonation

Grant admin consent
</code></pre></div>
<p>CLI alternative if Azure Cognitive Search does not appear in the picker. First, discover the Azure AI Search resource application ID and the scope ID.</p>
<div class="highlight"><pre><span></span><code>az rest --method GET --url &quot;https://graph.microsoft.com/v1.0/servicePrincipals?$filter=servicePrincipalNames/any(s:s eq &#39;https://search.azure.com&#39;)&amp;$select=appId,displayName,oauth2PermissionScopes&quot; --query &quot;value[0].{resourceAppId:appId,scopeId:oauth2PermissionScopes[?value==&#39;user_impersonation&#39;].id | [0],name:displayName}&quot;
</code></pre></div>
<p>Then add the permission and grant consent.</p>
<div class="highlight"><pre><span></span><code>az ad app permission add --id &lt;replace-by-app-client-id&gt; --api &lt;SEARCH_RESOURCE_APP_ID&gt; --api-permissions &lt;SCOPE_ID&gt;=Scope
az ad app permission admin-consent --id &lt;replace-by-app-client-id&gt;
</code></pre></div>
<p>Validate the configured permissions.</p>
<div class="highlight"><pre><span></span><code>az ad app permission list --id &lt;replace-by-app-client-id&gt;
</code></pre></div>
<p><strong>6) Configure the following app configuration settings used by the authentication flow.</strong></p>
<p>GPT-RAG authentication settings are configured in <strong>Azure App Configuration</strong>. Create the keys below in App Configuration and apply the <strong>gpt-rag</strong> label. For non-secret settings, store the value as plain text. For secret settings, store the value in <strong>Key Vault</strong> and add the key in App Configuration as a <strong>Key Vault reference</strong> (also under the <strong>gpt-rag</strong> label).</p>
<p>At a minimum, you only need to set the settings marked as <strong>Required</strong> in the table below. The remaining settings are optional and only needed if you want to customize behavior.</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Required</th>
<th>Secret?</th>
<th>What it controls</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OAUTH_AZURE_AD_CLIENT_ID</code></td>
<td>Yes (for OAuth)</td>
<td>No</td>
<td>Entra App Registration application (client) ID used by the UI OAuth provider to request tokens for the orchestrator API.</td>
</tr>
<tr>
<td><code>OAUTH_AZURE_AD_TENANT_ID</code></td>
<td>Yes (for OAuth)</td>
<td>No</td>
<td>Entra tenant ID used to validate/target the tenant for the OAuth flow (single-tenant by default).</td>
</tr>
<tr>
<td><code>OAUTH_AZURE_AD_CLIENT_SECRET</code></td>
<td>Yes (for OAuth)</td>
<td>Yes</td>
<td>Client secret used by the app for confidential-client flows (for example, completing the OAuth code flow and performing the OBO exchange). Store as a Key Vault secret and reference it from App Configuration (or from App Settings if you bypass App Configuration).</td>
</tr>
<tr>
<td><code>CHAINLIT_AUTH_SECRET</code></td>
<td>Yes</td>
<td>Yes</td>
<td>Secret used by Chainlit to sign its session JWT. If missing, the UI generates a temporary value (sessions reset on restart). Store as a Key Vault secret and reference it from App Configuration (or from App Settings if you bypass App Configuration).</td>
</tr>
<tr>
<td><code>CHAINLIT_URL</code></td>
<td>No</td>
<td>No</td>
<td>Public base URL of the UI. Used to build the OAuth redirect/callback URL (and normalized without a trailing slash).</td>
</tr>
<tr>
<td><code>OAUTH_AZURE_AD_SCOPES</code></td>
<td>No</td>
<td>No</td>
<td>Scopes requested during interactive login. If omitted, the UI defaults to the orchestrator API scope plus OpenID Connect scopes. Setting this explicitly helps avoid accidentally getting Microsoft Graph tokens.</td>
</tr>
<tr>
<td><code>OAUTH_AZURE_AD_ENABLE_SINGLE_TENANT</code></td>
<td>No</td>
<td>No</td>
<td>Defaults to <code>true</code>. When <code>true</code>, the UI enforces single-tenant behavior for the OAuth flow. Set to <code>false</code> only for multi-tenant scenarios.</td>
</tr>
<tr>
<td><code>ALLOW_ANONYMOUS</code></td>
<td>No</td>
<td>No</td>
<td>When <code>true</code>, the UI runs without OAuth (anonymous mode). Defaults to <code>true</code> locally when OAuth is not configured.</td>
</tr>
</tbody>
</table>
<p><strong>7) Configure the Azure AI Search index for document-level access control and ensure your documents include permission metadata.</strong></p>
<p>In the index definition, set <code>permissionFilterOption</code> to <code>enabled</code>.</p>
<p>These are the Azure AI Search index fields used for document-level access control:</p>
<div class="highlight"><pre><span></span><code>metadata_security_user_ids   Collection(Edm.String)   permissionFilter=userIds
metadata_security_group_ids  Collection(Edm.String)   permissionFilter=groupIds
metadata_security_rbac_scope Edm.String               permissionFilter=rbacScope
</code></pre></div>
<p>During Blob Storage ingestion, the GPT-RAG ingestion pipeline reads the following blob metadata keys and adds them to the corresponding documents in the index. If you want to specify which users or groups can access a document, set these metadata fields on each blob.</p>
<div class="highlight"><pre><span></span><code>metadata_security_user_ids
metadata_security_group_ids
</code></pre></div>
<blockquote>
<p>Note: For SharePoint ingestion, you don't need any additional steps. The GPT-RAG ingestion pipeline typically derives the user and group ACLs from the source SharePoint document or list item permissions and populates the same fields automatically.</p>
</blockquote>
<p>Examples of how to populate <code>metadata_security_user_ids</code> and <code>metadata_security_group_ids</code>.</p>
<div class="highlight"><pre><span></span><code>[&quot;11111111-1111-1111-1111-111111111111&quot;]
[&quot;11111111-1111-1111-1111-111111111111&quot;,&quot;22222222-2222-2222-2222-222222222222&quot;]
11111111-1111-1111-1111-111111111111,22222222-2222-2222-2222-222222222222
[&#39;11111111-1111-1111-1111-111111111111&#39;,&#39;22222222-2222-2222-2222-222222222222&#39;]
</code></pre></div>
<blockquote>
<p>Note: For Blob Storage ingestion, the GPT-RAG ingestion pipeline will populate <code>metadata_security_rbac_scope</code> automatically. The value is the Azure resource ID of the container, for example:
<em>/subscriptions/&lt;subscriptionId&gt;/resourceGroups/&lt;resourceGroup&gt;/providers/Microsoft.Storage/storageAccounts/&lt;storageAccount&gt;/blobServices/default/containers/&lt;container&gt;</em></p>
</blockquote>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <div style="
  background-color: var(--md-primary-fg-color);
  color: var(--md-primary-bg-color);
  text-align: center;
  font-size: 0.95em;
  padding: 1em 0;
">
  © 2025 GPT-RAG — powered by ❤️ and coffee ☕
</div>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.icon", "content.iconify", "navigation.tracking", "toc.integrate", "content.code.annotate", "navigation.top"], "search": "../assets/javascripts/workers/search.07f07601.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.56dfad97.min.js"></script>
      
    
  </body>
</html>