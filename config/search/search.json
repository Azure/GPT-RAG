{
    "datasources": [
    {
        "name": "{searchRagIndexDataSourceName}",
        "description": "Datastore for ragindex",
        "type": "azureblob",
        "credentials": {
            "connectionString": "ResourceId={storageAccountResourceId}/;"
        },
        "container": {
            "name": "documents",
            "query": ""
        },
        "dataDeletionDetectionPolicy": {
            "@odata.type": "#Microsoft.Azure.Search.NativeBlobSoftDeleteDeletionDetectionPolicy"
        }
    },
    {
        "name": "{searchMeasuresIndexDataSourceName}",
        "description": "Datastore for nl2sql-measures",
        "type": "azureblob",
        "credentials": {
            "connectionString": "ResourceId={storageAccountResourceId}/;"
        },
        "container": {
          "name": "nl2sql",
          "query": "measures/"
        },
        "dataDeletionDetectionPolicy": {
          "@odata.type": "#Microsoft.Azure.Search.NativeBlobSoftDeleteDeletionDetectionPolicy"
        }
      },
      {
        "name": "{searchQueriesIndexDataSourceName}",
        "description": "Datastore for nl2sql-queries",
        "type": "azureblob",
        "subtype": null,
        "credentials": {
            "connectionString": "ResourceId={storageAccountResourceId}/;"
        },
        "container": {
          "name": "nl2sql",
          "query": "queries/"
        },
        "dataDeletionDetectionPolicy": {
          "@odata.type": "#Microsoft.Azure.Search.NativeBlobSoftDeleteDeletionDetectionPolicy"
        }
      },
      

      {
        "name": "{searchTablesIndexDataSourceName}",
        "description": "Datastore for nl2sql-tables",
        "type": "azureblob",
        "subtype": null,
        "credentials": {
            "connectionString": "ResourceId={storageAccountResourceId}/;"
        },
        "container": {
          "name": "nl2sql",
          "query": "tables/"
        },
        "dataChangeDetectionPolicy": null,
        "dataDeletionDetectionPolicy": {
          "@odata.type": "#Microsoft.Azure.Search.NativeBlobSoftDeleteDeletionDetectionPolicy"
        },
        "encryptionKey": null,
        "identity": null
      }

    ],
  
    "indexes": [
      {
        "name": "{searchRagIndexName}",    
        "fields": [
          { "name": "id",                          "type": "Edm.String",               "key": true,  "searchable": true,  "retrievable": true,  "analyzer": "keyword" },
          { "name": "parent_id",                   "type": "Edm.String",               "searchable": false, "retrievable": true },
          { "name": "metadata_storage_path",       "type": "Edm.String",               "searchable": false, "retrievable": true },
          { "name": "metadata_storage_name",       "type": "Edm.String",               "searchable": false, "retrievable": true },
          { "name": "metadata_storage_last_modified", "type": "Edm.DateTimeOffset",    "searchable": false, "retrievable": true, "sortable": true, "filterable": true },
          { "name": "metadata_security_id",        "type": "Collection(Edm.String)",   "searchable": false, "retrievable": true, "filterable": true },
          { "name": "chunk_id",                    "type": "Edm.Int32",                "searchable": false, "retrievable": true },
          { "name": "content",                     "type": "Edm.String",               "searchable": true,  "retrievable": true, "analyzer": "{searchAnalyzerName}" },
          { "name": "imageCaptions",               "type": "Edm.String",               "searchable": true,  "retrievable": true, "analyzer": "{searchAnalyzerName}" },
          { "name": "page",                        "type": "Edm.Int32",                "searchable": false, "retrievable": true },
          { "name": "offset",                      "type": "Edm.Int64",                "searchable": false, "retrievable": true },
          { "name": "length",                      "type": "Edm.Int32",                "searchable": false, "retrievable": true },
          { "name": "title",                       "type": "Edm.String",               "searchable": true,  "retrievable": true,  "filterable": true, "analyzer": "{searchAnalyzerName}" },
          { "name": "category",                    "type": "Edm.String",               "searchable": true,  "retrievable": true,  "filterable": true, "analyzer": "{searchAnalyzerName}" },
          { "name": "filepath",                    "type": "Edm.String",               "searchable": false, "retrievable": true },
          { "name": "url",                         "type": "Edm.String",               "searchable": false, "retrievable": true },
          { "name": "summary",                     "type": "Edm.String",               "searchable": true,  "retrievable": true },
          { "name": "relatedImages",               "type": "Collection(Edm.String)",   "searchable": false, "retrievable": true },
          { "name": "relatedFiles",                "type": "Collection(Edm.String)",   "searchable": false, "retrievable": true },
          { "name": "source",                      "type": "Edm.String",               "searchable": false, "retrievable": true,  "filterable": true },
          { "name": "contentVector",               "type": "Collection(Edm.Single)",   "searchable": true,  "retrievable": true,  "dimensions": "{embeddingsVectorDimensions}", "vectorSearchProfile": "default" },
          { "name": "captionVector",               "type": "Collection(Edm.Single)",   "searchable": true,  "retrievable": true,  "dimensions": "{embeddingsVectorDimensions}", "vectorSearchProfile": "default" }
        ],
        "corsOptions": {
          "allowedOrigins": ["*"],
          "maxAgeInSeconds": 60
        },
        "vectorSearch": {
          "profiles": [
            { "name": "default", "algorithm": "hnsw" }
          ],
          "algorithms": [
            {
              "name": "hnsw",
              "kind": "hnsw",
              "hnswParameters": { "m": 4, "efConstruction": 400, "efSearch": 500, "metric": "cosine" }
            }
          ]
        },
        "semantic": {
          "configurations": [
            {
              "name": "semantic-config",
              "prioritizedFields": {
                "prioritizedContentFields": [
                  { "fieldName": "content" },
                  { "fieldName": "imageCaptions" }
                ],
                "prioritizedKeywordsFields": [
                  { "fieldName": "category" }
                ]
              }
            }
          ]
        }
      },
      {
        "name": "{searchQueriesIndexName}", 
        "fields": [
          { "name": "id",            "type": "Edm.String",               "key": true },
          { "name": "datasource",    "type": "Edm.String",               "searchable": true, "filterable": true, "retrievable": true },
          { "name": "question",      "type": "Edm.String",               "searchable": true, "retrievable": true, "analyzer": "{searchAnalyzerName}" },
          { "name": "query",         "type": "Edm.String",               "searchable": false },
          { "name": "reasoning",     "type": "Edm.String",               "searchable": true },
          { "name": "contentVector", "type": "Collection(Edm.Single)",   "searchable": true, "dimensions": "{embeddingsVectorDimensions}", "vectorSearchProfile": "default" }
        ],
        "corsOptions": {
          "allowedOrigins": ["*"],
          "maxAgeInSeconds": 60
        },
        "vectorSearch": {
          "profiles": [
            { "name": "default", "algorithm": "hnsw" }
          ],
          "algorithms": [
            {
              "name": "hnsw",
              "kind": "hnsw",
              "hnswParameters": { "m": 4, "efConstruction": 400, "efSearch": 500, "metric": "cosine" }
            }
          ]
        }        
      },
      {
        "name": "{searchTablesIndexName}",
        "fields": [
          { "name": "id",            "type": "Edm.String",               "key": true },
          { "name": "table",         "type": "Edm.String",               "searchable": true, "retrievable": true },
          { "name": "description",   "type": "Edm.String",               "searchable": true, "analyzer": "{searchAnalyzerName}" },
          { "name": "datasource",    "type": "Edm.String",               "searchable": true },
          {
            "name": "columns",
            "type": "Collection(Edm.ComplexType)",
            "fields": [
              { "name": "name",        "type": "Edm.String", "searchable": true },
              { "name": "description", "type": "Edm.String", "searchable": true, "analyzer": "{searchAnalyzerName}" },
              { "name": "type",        "type": "Edm.String" },
              { "name": "examples",    "type": "Collection(Edm.String)" }
            ]
          },
          { "name": "contentVector", "type": "Collection(Edm.Single)", "searchable": true, "dimensions": "{embeddingsVectorDimensions}", "vectorSearchProfile": "default" }
        ],
        "corsOptions": {
          "allowedOrigins": ["*"],
          "maxAgeInSeconds": 60
        },
        "vectorSearch": {
          "profiles": [
            { "name": "default", "algorithm": "hnsw" }
          ],
          "algorithms": [
            {
              "name": "hnsw",
              "kind": "hnsw",
              "hnswParameters": { "m": 4, "efConstruction": 400, "efSearch": 500, "metric": "cosine" }
            }
          ]
        }
      },
      {
        "name": "{searchMeasuresIndexName}",
        "fields": [
          { "name": "id",            "type": "Edm.String",             "key": true },
          { "name": "datasource",    "type": "Edm.String",             "searchable": true, "filterable": true },
          { "name": "name",          "type": "Edm.String",             "searchable": true, "filterable": true },
          { "name": "description",   "type": "Edm.String",             "searchable": true, "analyzer": "{searchAnalyzerName}" },
          { "name": "type",          "type": "Edm.String",             "searchable": true, "filterable": true },
          { "name": "source_table",  "type": "Edm.String",             "searchable": true, "filterable": true },
          { "name": "data_type",     "type": "Edm.String",             "searchable": true },
          { "name": "source_model",  "type": "Edm.String",             "searchable": true },
          { "name": "contentVector", "type": "Collection(Edm.Single)", "searchable": true, "dimensions": "{embeddingsVectorDimensions}", "vectorSearchProfile": "default" }
        ],
        "corsOptions": {
          "allowedOrigins": ["*"],
          "maxAgeInSeconds": 60
        },
        "vectorSearch": {
          "profiles": [
            { "name": "default", "algorithm": "hnsw" }
          ],
          "algorithms": [
            {
              "name": "hnsw",
              "kind": "hnsw",
              "hnswParameters": { "m": 4, "efConstruction": 400, "efSearch": 500, "metric": "cosine" }
            }
          ]
        }
      }
    ],
  
    "skillsets": [
      {
        "name": "{searchRagIndexSkillsetName}",
        "description": "Document chunking skillset",
        "skills": [
          {
            "@odata.type": "#Microsoft.Skills.Custom.WebApiSkill",
            "name": "document-chunking",
            "description": "Extract chunks from documents.",
            "uri": "https://{CONTAINER_APPS.dataIngestApp.fqdn}/document-chunking",  
            "httpMethod": "POST",
            "timeout": "PT230S",
            "context": "/document",
            "batchSize": 1,
            "inputs": [
              { "name": "documentUrl",          "source": "/document/metadata_storage_path" },
              { "name": "documentSasToken",     "source": "/document/metadata_storage_sas_token" },
              { "name": "documentContentType",  "source": "/document/metadata_content_type" }
            ],
            "outputs": [
              { "name": "chunks", "targetName": "chunks" }
            ]
          }
        ],
        "indexProjections": {
          "selectors": [
            {
              "targetIndexName": "{searchRagIndexName}",
              "parentKeyFieldName": "parent_id",
              "sourceContext": "/document/chunks/*",
              "mappings": [
                { "name": "chunk_id",                      "source": "/document/chunks/*/chunk_id" },
                { "name": "offset",                        "source": "/document/chunks/*/offset" },
                { "name": "length",                        "source": "/document/chunks/*/length" },
                { "name": "page",                          "source": "/document/chunks/*/page" },
                { "name": "title",                         "source": "/document/chunks/*/title" },
                { "name": "category",                      "source": "/document/chunks/*/category" },
                { "name": "url",                           "source": "/document/chunks/*/url" },
                { "name": "relatedImages",                 "source": "/document/chunks/*/relatedImages" },
                { "name": "relatedFiles",                  "source": "/document/chunks/*/relatedFiles" },
                { "name": "filepath",                      "source": "/document/chunks/*/filepath" },
                { "name": "content",                       "source": "/document/chunks/*/content" },
                { "name": "imageCaptions",                 "source": "/document/chunks/*/imageCaptions" },
                { "name": "summary",                       "source": "/document/chunks/*/summary" },
                { "name": "source",                        "source": "/document/chunks/*/source" },
                { "name": "captionVector",                 "source": "/document/chunks/*/captionVector" },
                { "name": "contentVector",                 "source": "/document/chunks/*/contentVector" },
                { "name": "metadata_storage_last_modified","source": "/document/metadata_storage_last_modified" },
                { "name": "metadata_storage_name",         "source": "/document/metadata_storage_name" },
                { "name": "metadata_storage_path",         "source": "/document/metadata_storage_path" },
                { "name": "metadata_security_id",          "source": "/document/metadata_security_id" }
              ]
            }
          ],
          "parameters": {
            "projectionMode": "skipIndexingParentDocuments"
          }
        }
      },
      {
        "name": "{searchQueriesIndexSkillsetName}",
        "description": "Embedding skillset for queries",
        "skills": [
          {
            "@odata.type": "#Microsoft.Skills.Custom.WebApiSkill",
            "name": "{searchQueriesIndexSkillsetName}",
            "description": "Generates embeddings for question.",
            "uri": "https://{CONTAINER_APPS.dataIngestApp.fqdn}/text-embedding",
            "httpMethod": "POST",
            "batchSize": 1,
            "timeout": "PT60S",
            "context": "/document",
            "inputs": [
              { "name": "id",   "source": "/document/id" },
              { "name": "text", "source": "/document/question" }
            ],
            "outputs": [
              { "name": "embedding", "targetName": "contentVector" }
            ]
          }
        ]
      },
      {
        "name": "{searchTablesIndexSkillsetName}",
        "description": "Embedding skillset for tables",
        "skills": [
          {
            "@odata.type": "#Microsoft.Skills.Custom.WebApiSkill",
            "name": "{searchTablesIndexSkillsetName}",
            "description": "Generates embeddings for description.",
            "uri": "https://{CONTAINER_APPS.dataIngestApp.fqdn}/text-embedding",
            "httpMethod": "POST",
            "batchSize": 1,
            "timeout": "PT60S",
            "context": "/document",
            "inputs": [
              { "name": "id",   "source": "/document/id" },
              { "name": "text", "source": "/document/description" }
            ],
            "outputs": [
              { "name": "embedding", "targetName": "contentVector" }
            ]
          }
        ]
      },
      {
        "name": "{searchMeasuresIndexSkillsetName}",
        "description": "Embedding skillset for measures",
        "skills": [
          {
            "@odata.type": "#Microsoft.Skills.Custom.WebApiSkill",
            "name": "{searchMeasuresIndexSkillsetName}",
            "description": "Generates embeddings for description.",
            "uri": "https://{CONTAINER_APPS.dataIngestApp.fqdn}/text-embedding",
            "httpMethod": "POST",
            "batchSize": 1,
            "timeout": "PT60S",
            "context": "/document",
            "inputs": [
              { "name": "id",   "source": "/document/id" },
              { "name": "text", "source": "/document/description" }
            ],
            "outputs": [
              { "name": "embedding", "targetName": "contentVector" }
            ]
          }
        ]
      }
    ],
  
    "indexers": [
      {
        "name": "{searchRagIndexIndexerName}",
        "body": {
          "dataSourceName": "{searchRagIndexDataSourceName}",
          "targetIndexName": "{searchRagIndexName}",
          "skillsetName": "{searchRagIndexSkillsetName}",
          "schedule": { "interval": "{searchRagIndexInterval}" },
          "fieldMappings": [
            { "sourceFieldName": "metadata_storage_path", "targetFieldName": "id", "mappingFunction": { "name": "fixedLengthEncode" } }
          ],
          "parameters": {
            "batchSize": 1,
            "maxFailedItems": -1,
            "maxFailedItemsPerBatch": -1,
            "configuration": {
              "dataToExtract": "allMetadata"
            }
          }          
        }
      },
      {
        "name": "{searchQueriesIndexIndexerName}",
        "body": {
          "dataSourceName": "{searchQueriesIndexDataSourceName}",
          "targetIndexName": "{searchQueriesIndexName}",
          "skillsetName": "{searchQueriesIndexSkillsetName}",
          "schedule": { "interval": "{searchQueriesIndexInterval}" },
          "fieldMappings": [
            { "sourceFieldName": "metadata_storage_path", "targetFieldName": "id", "mappingFunction": { "name": "fixedLengthEncode" } },
            { "sourceFieldName": "datasource",            "targetFieldName": "datasource" },
            { "sourceFieldName": "question",              "targetFieldName": "question" },
            { "sourceFieldName": "query",                 "targetFieldName": "query" },
            { "sourceFieldName": "reasoning",             "targetFieldName": "reasoning" }
          ],
          "parameters": {
            "configuration": { "parsingMode": "json" }
          }
        }
      },
      {
        "name": "{searchTablesIndexIndexerName}",
        "body": {
          "dataSourceName": "{searchTablesIndexDataSourceName}",
          "targetIndexName": "{searchTablesIndexName}",
          "skillsetName": "{searchTablesIndexSkillsetName}",
          "schedule": { "interval": "{searchTablesIndexInterval}" },
          "fieldMappings": [
            { "sourceFieldName": "metadata_storage_path", "targetFieldName": "id", "mappingFunction": { "name": "fixedLengthEncode" } },
            { "sourceFieldName": "table",                "targetFieldName": "table" },
            { "sourceFieldName": "description",          "targetFieldName": "description" },
            { "sourceFieldName": "datasource",           "targetFieldName": "datasource" },
            { "sourceFieldName": "columns",              "targetFieldName": "columns" }
          ],
          "parameters": {
            "configuration": { "parsingMode": "json" }
          }
        }
      },
      {
        "name": "{searchMeasuresIndexIndexerName}",
        "body": {
          "dataSourceName": "{searchMeasuresIndexDataSourceName}",
          "targetIndexName": "{searchMeasuresIndexName}",
          "skillsetName": "{searchMeasuresIndexSkillsetName}",
          "schedule": { "interval": "{searchMeasuresIndexInterval}" },
          "fieldMappings": [
            { "sourceFieldName": "metadata_storage_path", "targetFieldName": "id", "mappingFunction": { "name": "fixedLengthEncode" } },
            { "sourceFieldName": "datasource",            "targetFieldName": "datasource" },
            { "sourceFieldName": "name",                  "targetFieldName": "name" },
            { "sourceFieldName": "description",           "targetFieldName": "description" },
            { "sourceFieldName": "type",                  "targetFieldName": "type" },
            { "sourceFieldName": "source_table",          "targetFieldName": "source_table" },
            { "sourceFieldName": "data_type",             "targetFieldName": "data_type" },
            { "sourceFieldName": "source_model",          "targetFieldName": "source_model" }
          ],
          "parameters": {
            "configuration": { "parsingMode": "json" }
          }
        }
      }
    ]
  }