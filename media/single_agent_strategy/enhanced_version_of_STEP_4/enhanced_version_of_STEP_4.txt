sequenceDiagram
    participant Strategy as SingleAgentRAGStrategy<br/>(Local)
    participant ProjectClient as project_client<br/>(Local Proxy)
    participant EventHandler as EventHandler<br/>(Local)
    participant AIFoundry as Azure AI Foundry<br/>(API Gateway)
    participant Agent as Agent Instance<br/>(Remote Entity)
    participant Thread as Thread Instance<br/>(Remote Entity)
    participant Run as Run Instance<br/>(Remote Entity)
    participant SearchIndex as Azure AI Search<br/>(Remote Service)
    participant BingSearch as Bing Search<br/>(Remote Service)
    participant LLM as Azure OpenAI<br/>(Remote Model)

    rect rgb(255, 255, 200)
        Note over Strategy, LLM: STEP 4: Stream Agent Response (Detailed Remote Execution)
        
        Strategy->>ProjectClient: agents.runs.stream(thread_id, agent_id, event_handler)
        ProjectClient->>AIFoundry: HTTP POST /threads/{thread_id}/runs<br/>{agent_id: xxx, stream: true}
        
        Note over AIFoundry: Create Run instance linking Agent & Thread
        AIFoundry->>Run: create(agent_id, thread_id)
        Run-->>AIFoundry: Run created with ID
        AIFoundry-->>ProjectClient: Stream connection established
        ProjectClient-->>Strategy: Stream context opened
        
        Note over Strategy: Enter streaming loop
        
        loop Streaming Events from Run Execution
            
            Note over Run: Initialize execution
            Run->>Thread: read_messages()
            Thread-->>Run: message_history[]
            Run->>Agent: get_instructions_and_tools()
            Agent-->>Run: {instructions, tools_list, model_config}
            
            Run-->>AIFoundry: event: "thread.run.created"
            AIFoundry-->>ProjectClient: Server-Sent Event
            ProjectClient->>EventHandler: on_thread_run(run)
            EventHandler-->>Strategy: "Thread run status: in_progress"
            
            Note over Run: Start processing with LLM
            Run->>LLM: process_messages(history, instructions)
            
            alt Agent needs to use tools
                Note over Run: Agent decides to call tools
                Run-->>AIFoundry: event: "thread.run.requires_action"
                AIFoundry-->>ProjectClient: Server-Sent Event
                ProjectClient->>EventHandler: on_run_step(step)
                EventHandler-->>Strategy: "Run step: type=tool_calls, status=in_progress"
                
                par Tool Calls (Parallel execution)
                    Run->>SearchIndex: search_query("user question context")
                    SearchIndex-->>Run: search_results[]
                and
                    Run->>BingSearch: search("current information")
                    BingSearch-->>Run: web_results[]
                end
                
                Note over Run: Aggregate tool results
                Run->>LLM: process_with_tool_results(search_results, web_results)
            end
            
            Note over LLM: Generate response with streaming
            loop Response Generation (Token by token)
                LLM-->>Run: response_token_delta
                Run-->>AIFoundry: event: "thread.message.delta"
                AIFoundry-->>ProjectClient: Server-Sent Event
                ProjectClient->>Strategy: event_type="thread.message.delta", event_data=delta
                
                alt event has text content
                    Strategy->>EventHandler: on_message_delta(delta)
                    Note over EventHandler: Process citations<br/>Replace placeholders with URLs
                    EventHandler-->>Strategy: formatted_text_chunk
                    Strategy-->>Strategy: yield formatted_text_chunk
                end
            end
            
            Note over Run: Finalize response
            Run->>Thread: append_message(role="assistant", content=full_response)
            Thread-->>Run: message_stored
            
            Run-->>AIFoundry: event: "thread.message.completed"
            AIFoundry-->>ProjectClient: Server-Sent Event
            ProjectClient->>EventHandler: on_thread_message(message)
            EventHandler-->>Strategy: "Thread message created: ID=msg_xxx, status=completed"
            
            Run-->>AIFoundry: event: "thread.run.completed"
            AIFoundry-->>ProjectClient: Server-Sent Event
            ProjectClient->>EventHandler: on_thread_run(run)
            EventHandler-->>Strategy: "Thread run status: completed"
            
        end
        
        Note over ProjectClient: Stream connection closes
        ProjectClient->>EventHandler: on_done()
        EventHandler-->>Strategy: "Streaming completed"
        
        Note over Strategy: Exit streaming context
    end