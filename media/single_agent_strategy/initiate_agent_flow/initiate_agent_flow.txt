sequenceDiagram
    participant User as User/Caller
    participant Strategy as SingleAgentRAGStrategy<br/>(Local)
    participant Conv as self.conversation<br/>(Local State)
    participant ProjectClient as project_client<br/>(Local Proxy)
    participant AIFoundry as Azure AI Foundry<br/>(Remote)
    participant EventHandler as EventHandler<br/>(Local)
    participant SearchIndex as Azure AI Search<br/>(Remote)

    User->>Strategy: initiate_agent_flow(user_message)
    
    Note over Strategy: LOCAL: Method starts
    Strategy->>Conv: get("thread_id")
    Conv-->>Strategy: thread_id or None
    
    Strategy->>ProjectClient: async with self.project_client
    Note over ProjectClient: LOCAL: Context manager entry
    
    rect rgb(255, 240, 240)
        Note over Strategy, AIFoundry: STEP 1: Agent Management (Remote)
        alt existing_agent_id exists
            Strategy->>ProjectClient: agents.get_agent(existing_agent_id)
            ProjectClient->>AIFoundry: HTTP GET /agents/{id}
            AIFoundry-->>ProjectClient: Agent object
            ProjectClient-->>Strategy: agent
        else create new agent
            Strategy->>ProjectClient: agents.create_agent(model, name, instructions, tools)
            ProjectClient->>AIFoundry: HTTP POST /agents
            AIFoundry-->>ProjectClient: New Agent object
            ProjectClient-->>Strategy: agent
        end
        Strategy->>Conv: store agent_id
    end
    
    rect rgb(240, 255, 240)
        Note over Strategy, AIFoundry: STEP 2: Thread Management (Remote)
        alt thread_id exists
            Strategy->>ProjectClient: agents.threads.get(thread_id)
            ProjectClient->>AIFoundry: HTTP GET /threads/{id}
            AIFoundry-->>ProjectClient: Thread object
            ProjectClient-->>Strategy: thread
        else create new thread
            Strategy->>ProjectClient: agents.threads.create()
            ProjectClient->>AIFoundry: HTTP POST /threads
            AIFoundry-->>ProjectClient: New Thread object
            ProjectClient-->>Strategy: thread
        end
        Strategy->>Conv: store thread_id
    end
    
    rect rgb(240, 240, 255)
        Note over Strategy, AIFoundry: STEP 3: Send User Message (Remote)
        Strategy->>ProjectClient: agents.messages.create(thread_id, role="user", content=user_message)
        ProjectClient->>AIFoundry: HTTP POST /threads/{id}/messages
        AIFoundry-->>ProjectClient: Message confirmation
        ProjectClient-->>Strategy: message created
    end
    
    rect rgb(255, 255, 200)
        Note over Strategy, SearchIndex: STEP 4: Stream Agent Response (Remote Execution, Local Processing)
        Strategy->>ProjectClient: agents.runs.stream(thread_id, agent_id, event_handler)
        ProjectClient->>AIFoundry: HTTP POST /threads/{id}/runs (with streaming)
        
        Note over AIFoundry: Agent processes message<br/>May call tools internally
        AIFoundry->>SearchIndex: Search queries (if needed)
        SearchIndex-->>AIFoundry: Search results
        
        loop Streaming Events
            AIFoundry-->>ProjectClient: Server-Sent Events
            ProjectClient-->>Strategy: event_type, event_data, raw
            
            alt event_type == "thread.message.delta"
                Strategy->>EventHandler: on_message_delta(event_data)
                EventHandler-->>Strategy: processed text chunk
                Strategy-->>User: yield chunk (LOCAL PROCESSING)
            else event_type == "thread.run.failed"
                Strategy-->>User: raise Exception
            end
        end
        
        Note over ProjectClient: Streaming context closes
    end
    
    rect rgb(200, 255, 255)
        Note over Strategy, AIFoundry: STEP 5: Retrieve Full Conversation (Remote)
        Strategy->>ProjectClient: agents.messages.list(thread_id, order=ASCENDING)
        ProjectClient->>AIFoundry: HTTP GET /threads/{id}/messages
        
        loop For each message
            AIFoundry-->>ProjectClient: Message object
            ProjectClient-->>Strategy: msg
            Strategy->>Conv: append message to conv["messages"]
        end
    end
    
    rect rgb(255, 200, 200)
        Note over Strategy, AIFoundry: STEP 6: Cleanup (Remote, if needed)
        alt create_agent was True
            Strategy->>ProjectClient: agents.delete_agent(agent.id)
            ProjectClient->>AIFoundry: HTTP DELETE /agents/{id}
            AIFoundry-->>ProjectClient: Deletion confirmation
            ProjectClient-->>Strategy: agent deleted
        end
    end
    
    Note over Strategy: LOCAL: Method completes
    Strategy-->>User: Generator exhausted